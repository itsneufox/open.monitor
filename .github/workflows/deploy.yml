name: ðŸš€ open.monitor deploy
on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
 
    steps:
    - name: ðŸ“¡ Mission Control - Downloading Flight Plans
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Pre-Flight Systems Check
      run: |
        if command -v apk >/dev/null 2>&1; then
          echo "ðŸ›°ï¸ Alpine launch pad detected - Installing rocket fuel..."
          sudo apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev giflib-dev
          sudo ln -sf python3 /usr/bin/python
        elif command -v apt-get >/dev/null 2>&1; then
          echo "ðŸ›°ï¸ Ubuntu/Debian launch facility confirmed - Fueling systems..."
          sudo apt-get update
          sudo apt-get install -y python3 make g++ pkg-config libcairo2-dev libpango1.0-dev libgif-dev
          sudo ln -sf python3 /usr/bin/python
        else
          echo "ðŸš¨ ABORT! Unknown launch platform detected!"
          exit 1
        fi
        echo "âœ… All systems green! Rocket fuel loaded! ðŸš€â›½"
        
    - name: ðŸ›¡ï¸ Loading Classified Mission Parameters
      run: |
        echo "ðŸ”’ Mission Control uploading top-secret coordinates..."
        cat > .env << EOF
        TOKEN=${{ secrets.DISCORD_TOKEN }}
        CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        OWNER_ID=${{ secrets.OWNER_ID }}
        NODE_ENV=production
        LOG_LEVEL=production
      
        # MySQL Configuration
        MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
        EOF
        echo "âœ… Navigation computer programmed! Coordinates locked! ðŸŽ¯"
      
    - name: ðŸš€ T-Minus Zero - open.monitor Launch Sequence
      run: |
        echo "ðŸŽ® Houston, we are GO for open.monitor launch!"
        echo "ðŸ‘¨â€ðŸš€ Flight Commander: $(whoami)"
        echo "ðŸ¢ Mission Control: $(pwd)"
        echo "ðŸ“‹ Mission Codename: ${{ github.repository }}"
        echo "ðŸ”¢ Flight Number: ${{ github.sha }}"
        echo "ðŸ“» Launch Authorization: ${{ github.event_name }}"
        
        echo "ðŸ’¥ Decommissioning old satellites... Controlled detonation in progress!"
        sudo docker-compose -f /opt/open.monitor/docker-compose.yml down --timeout 30 || true
      
        echo "ðŸ§¹ Clearing launch pad debris... All clear for takeoff!"
        sudo rm -rf /opt/open.monitor/*
        sudo mkdir -p /opt/open.monitor
      
        echo "ðŸ“¦ Loading cargo bay with mission payload..."
        sudo cp -r * /opt/open.monitor/
        sudo chown -R github-runner:github-runner /opt/open.monitor
      
        cd /opt/open.monitor
      
        echo "ðŸ—‘ï¸ Jettisoning space junk... Houston, we have clean orbit!"
        sudo docker image prune -f
      
        echo "ðŸ—ï¸ Assembling rocket components... 3D printing in space!"
        sudo docker-compose build --no-cache
      
        echo "ðŸš€ Initiating launch sequence..."
        echo ""
        echo "T-10" && sleep 1
        echo "T-9" && sleep 1
        echo "T-8" && sleep 1
        echo "T-7" && sleep 1
        echo "T-6" && sleep 1
        echo "T-5" && sleep 1
        echo "T-4" && sleep 1
        echo "T-3" && sleep 1
        echo "T-2" && sleep 1
        echo "T-1" && sleep 1
        echo "ðŸš€ LIFTOFF! WE HAVE LIFTOFF! ðŸŒŒ"
        echo ""
        
        sudo docker-compose up -d
      
        echo "â³ Waiting for orbital insertion... open.monitor entering atmosphere..."
        sleep 15
      
        if [ "$(sudo docker ps -q -f name=openmonitor-bot -f status=running)" ]; then
          echo "ðŸ›¸ WE HAVE SUCCESSFUL ORBITAL INSERTION! ðŸŽŠ"
          echo "ðŸ“¡ Satellite constellation status:"
          sudo docker ps --filter name=openmonitor
          echo "ðŸ“¢ First transmission from space:"
          sudo docker logs openmonitor-bot --tail 10
        else
          echo "ðŸ”¥ MAYDAY! MAYDAY! Rocket explosion detected! ðŸ’¥"
          echo "ðŸš¨ Emergency protocols activated - checking debris field..."
          sudo docker ps -a
          echo "ðŸ“» Final transmission from the wreckage:"
          sudo docker logs openmonitor-bot --tail 20 || echo "ðŸ“¡ Radio silence... we've lost contact ðŸ“»"
          exit 1
        fi
      
        echo "ðŸ›°ï¸ Space cleanup crew removing orbital debris..."
        sudo docker system prune -f
      
        echo "ðŸŒŸ MISSION SUCCESS! open.monitor is now in stable orbit!"
        echo "ðŸª Your SA:MP/open.mp servers are under cosmic surveillance! ðŸ‘½"
        echo "ðŸŒŒ May the servers be with you, Commander! ðŸ«¡"