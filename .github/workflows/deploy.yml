name: ğŸš€ open.monitor deploy
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
 
    steps:
    - name: ğŸ“¡ Mission Control - Downloading Flight Plans
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: ğŸ”§ Pre-Flight Systems Check
      run: |
        if command -v apk >/dev/null 2>&1; then
          echo "ğŸ›°ï¸ Alpine launch pad detected - Installing rocket fuel..."
          sudo apk add --no-cache python3 make g++ pkgconfig cairo-dev pango-dev giflib-dev
          sudo ln -sf python3 /usr/bin/python
        elif command -v apt-get >/dev/null 2>&1; then
          echo "ğŸ›°ï¸ Ubuntu/Debian launch facility confirmed - Fueling systems..."
          sudo apt-get update
          sudo apt-get install -y python3 make g++ pkg-config libcairo2-dev libpango1.0-dev libgif-dev
          sudo ln -sf python3 /usr/bin/python
        else
          echo "ğŸš¨ ABORT! Unknown launch platform detected!"
          exit 1
        fi
        echo "âœ… All systems green! Rocket fuel loaded! ğŸš€â›½"

    - name: ğŸ›°ï¸ Spacecraft Version Control System
      run: |
        echo "ğŸŒŒ Galactic Registry - Assigning new spacecraft serial number..."
        
        # Configure git for the space mission
        git config --local user.email "mission-control@open-monitor.space"
        git config --local user.name "ğŸ›°ï¸ Mission Control"
        
        # Get current version and bump it
        CURRENT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "1.0.0")
        echo "ğŸ“Š Current spacecraft model: v$CURRENT_VERSION"
        
        # Auto-bump patch version for scheduled space missions
        npm version patch --no-git-tag-version
        NEW_VERSION=$(node -p "require('./package.json').version")
        
        echo "ğŸ†• NEW_VERSION=v$NEW_VERSION" >> $GITHUB_ENV
        echo "ğŸš€ Upgraded spacecraft to model: v$NEW_VERSION"
        
        # Create git tag for the space mission
        git add package.json package-lock.json
        git commit -m "ğŸš€ Launch v$NEW_VERSION - Daily orbital deployment [skip ci]"
        git tag -a "v$NEW_VERSION" -m "ğŸ›°ï¸ Space Mission v$NEW_VERSION - Daily auto-deployment"
        
        # Push to the cosmic repository
        git push origin main
        git push origin "v$NEW_VERSION"
        
        echo "ğŸŒŸ Spacecraft v$NEW_VERSION registered in Galactic Database!"

    - name: ğŸ›¡ï¸ Loading Classified Mission Parameters  
      run: |
        echo "ğŸ”’ Mission Control uploading top-secret coordinates..."
        cat > .env << EOF
        TOKEN=${{ secrets.DISCORD_TOKEN }}
        CLIENT_ID=${{ secrets.DISCORD_CLIENT_ID }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        OWNER_ID=${{ secrets.OWNER_ID }}
        NODE_ENV=production
        LOG_LEVEL=production
        
        # Mission Version (for space tracking)
        BOT_VERSION=${NEW_VERSION:-latest}
        
        # MySQL Configuration
        MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
        
        # Valkey Configuration
        VALKEY_HOSTS=valkey:6379
        VALKEY_USE_TLS=false
        VALKEY_KEY_EXPIRY_SECONDS=540
        EOF
        echo "âœ… Navigation computer programmed! Coordinates locked! ğŸ¯"

    - name: ğŸ“‹ Mission Briefing - Spacecraft Specifications
      run: |
        SPACECRAFT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
        echo "ğŸ›°ï¸ =================================="
        echo "ğŸš€ DAILY SPACECRAFT MISSION BRIEFING"
        echo "ğŸ›°ï¸ =================================="
        echo "ğŸ“¦ Spacecraft Model: open.monitor v$SPACECRAFT_VERSION"
        echo "ğŸ·ï¸ Mission Tag: ${NEW_VERSION:-current-deployment}"
        echo "ğŸ‘¨â€ğŸš€ Pilot: Automated Mission Control"
        echo "ğŸŒ Launch Facility: $(pwd)"
        echo "ğŸ“¡ Mission Control: ${{ github.repository }}"
        echo "ğŸ”¢ Flight Serial: ${{ github.sha }}"
        echo "ğŸ“» Authorization: ${{ github.event_name }}"
        echo "â° Launch Time: $(date -u)"
        echo "ğŸ• Next Launch: Tomorrow 03:00 UTC"
        echo "ğŸ›°ï¸ =================================="
      
    - name: ğŸš€ T-Minus Zero - open.monitor Launch Sequence
      run: |
        echo "ğŸ® Houston, we are GO for DAILY open.monitor launch!"
        
        echo "ğŸ’¥ Decommissioning old satellites... Controlled detonation in progress!"
        sudo docker-compose -f /opt/open.monitor/docker-compose.yml down --timeout 30 || true
      
        echo "ğŸ§¹ Clearing launch pad debris... All clear for takeoff!"
        sudo rm -rf /opt/open.monitor/*
        sudo mkdir -p /opt/open.monitor
      
        echo "ğŸ“¦ Loading cargo bay with mission payload..."
        sudo cp -r * /opt/open.monitor/
        sudo chown -R github-runner:github-runner /opt/open.monitor
      
        cd /opt/open.monitor
      
        echo "ğŸ—‘ï¸ Jettisoning space junk... Houston, we have clean orbit!"
        sudo docker image prune -f
      
        echo "ğŸ—ï¸ Assembling rocket components... 3D printing in space!"
        sudo docker-compose build --no-cache
      
        echo "ğŸš€ Initiating launch sequence..."
        echo ""
        echo "T-10" && sleep 1
        echo "T-9" && sleep 1
        echo "T-8" && sleep 1
        echo "T-7" && sleep 1
        echo "T-6" && sleep 1
        echo "T-5" && sleep 1
        echo "T-4" && sleep 1
        echo "T-3" && sleep 1
        echo "T-2" && sleep 1
        echo "T-1" && sleep 1
        echo "ğŸš€ LIFTOFF! WE HAVE LIFTOFF! ğŸŒŒ"
        echo ""
        
        sudo docker-compose up -d
      
        echo "â³ Waiting for orbital insertion... open.monitor entering atmosphere..."
        sleep 15
      
        if [ "$(sudo docker ps -q -f name=openmonitor-bot -f status=running)" ]; then
          SPACECRAFT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
          echo "ğŸ›¸ WE HAVE SUCCESSFUL ORBITAL INSERTION! ğŸŠ"
          echo "ğŸŒŸ Spacecraft open.monitor v$SPACECRAFT_VERSION is now in stable orbit!"
          echo "ğŸ“¡ Satellite constellation status:"
          sudo docker ps --filter name=openmonitor
          echo "ğŸ“¢ First transmission from space:"
          sudo docker logs openmonitor-bot --tail 10
        else
          echo "ğŸ”¥ MAYDAY! MAYDAY! Rocket explosion detected! ğŸ’¥"
          echo "ğŸš¨ Emergency protocols activated - checking debris field..."
          sudo docker ps -a
          echo "ğŸ“» Final transmission from the wreckage:"
          sudo docker logs openmonitor-bot --tail 20 || echo "ğŸ“¡ Radio silence... we've lost contact ğŸ“»"
          exit 1
        fi
      
        echo "ğŸ›°ï¸ Space cleanup crew removing orbital debris..."
        sudo docker system prune -f
      
        echo "ğŸŒŸ MISSION SUCCESS! open.monitor is now in stable orbit!"
        echo "ğŸª Your SA:MP/open.mp servers are under cosmic surveillance! ğŸ‘½"
        echo "ğŸŒŒ May the servers be with you, Commander! ğŸ«¡"

    - name: ğŸŒŒ Daily Galactic Mission Report
      run: |
        SPACECRAFT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "unknown")
        echo "ğŸ“Š =================================="
        echo "ğŸ›°ï¸ DAILY MISSION ACCOMPLISHED!"
        echo "ğŸ“Š =================================="
        echo "ğŸš€ Spacecraft: open.monitor v$SPACECRAFT_VERSION"
        echo "ğŸ·ï¸ Mission Tag: ${NEW_VERSION}"
        echo "â° Mission Time: $(date -u)"
        echo "ğŸ“¡ Status: âœ… ORBITAL AND OPERATIONAL"
        echo "ğŸ• Next Launch: Tomorrow at 03:00 UTC"
        echo "ğŸŒŸ Status: Awaiting next automated mission"
        echo "ğŸ“Š =================================="